<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Thí sinh - Admin Skibidi</title>
    <link rel="stylesheet" href="./assets/css/admin.css">
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>Hệ Thống Quản Lý Thí Sinh</h1>
        </header>

        <main class="skibidi">
            <section class="dangnhap">
                <h3 id="formTitle">NHẬP DỮ LIỆU THÍ SINH</h3>
                <form id="adminSkibidi">
                    <input type="hidden" id="docId">
                    <div class="hihihahahuhu">
                        <label>CCCD</label>
                        <input type="text" id="cccd" required>
                    </div>

                    <div class="hihihahahuhu">
                        <label>Số báo danh</label>
                        <input type="text" id="sbd" required>
                    </div>

                    <div class="hihihahahuhu">
                        <label>Họ và tên</label>
                        <input type="text" id="hoten" required>
                    </div>

                    <div class="toilet">
                        <div class="hihihahahuhu">
                            <label>Ngữ văn</label>
                            <input type="number" id="van" required>
                        </div>
                        <div class="hihihahahuhu">
                            <label>Toán</label>
                            <input type="number" id="toan" required>
                        </div>
                        <div class="hihihahahuhu">
                            <label>Tiếng Anh</label>
                            <input type="number" id="anh" required>
                        </div>
                    </div>

                    <button type="submit" id="save" class="nutbam">LƯU DỮ LIỆU</button>
                    <button type="button" id="btnCancel" class="nutbam"
                        style="display:none; background:#6c757d; margin-top:10px;">HỦY CẬP NHẬT</button>

                </form>
            </section>

            <hr style="margin: 40px 0; border: 0; border-top: 1px solid #eee;">

            <section class="danh-sach">
                <h3>DANH SÁCH THÍ SINH</h3>
                <div style="overflow-x: auto;">
                    <table class="crud-skibidi">
                        <thead>
                            <tr>
                                <th>SBD</th>
                                <th>Họ Tên</th>
                                <th>Văn</th>
                                <th>Toán</th>
                                <th>Anh</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="skibidiTable">
                        </tbody>
                    </table>
                </div>
            </section>

            <div class="query">
                <p><a href="./index.html">Quay lại trang chủ</a></p>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBD7b3JnP_K3XQyv37mSPzDHDc1Sb795lM",
            authDomain: "jsi-33.firebaseapp.com",
            projectId: "jsi-33",
            storageBucket: "jsi-33.firebasestorage.app",
            messagingSenderId: "125271951640",
            appId: "1:125271951640:web:f7d2d98480b63617c7b66d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "skibidi");

        const form = document.getElementById("adminSkibidi");
        const tableBody = document.getElementById("skibidiTable");
        const btnSave = document.getElementById("save");
        const btnCancel = document.getElementById("btnCancel");
        const formTitle = document.getElementById("formTitle");


        onSnapshot(colRef, (snapshot) => {
            tableBody.innerHTML = "";
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${data.sbd}</td>
                    <td>${data.nemchua}</td>
                    <td>${data.tiengviet}</td>
                    <td>${data.toan}</td>
                    <td>${data.english}</td>
                    <td>
                        <button class="btn-edit" onclick="editStudent('${doc.id}', '${data.cccd}', '${data.sbd}', '${data.nemchua}', ${data.tiengviet}, ${data.toan}, ${data.english})">Sửa</button>
                        <button class="btn-delete" onclick="deleteStudent('${doc.id}')">Xóa</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("docId").value;
            const payload = {
                cccd: document.getElementById("cccd").value.trim(),
                sbd: document.getElementById("sbd").value.trim(),
                nemchua: document.getElementById("hoten").value.trim(),
                tiengviet: Number(document.getElementById("van").value),
                toan: Number(document.getElementById("toan").value),
                english: Number(document.getElementById("anh").value),
                updatedAt: serverTimestamp()
            };

            try {
                if (id === "") {

                    await addDoc(colRef, { ...payload, createdAt: serverTimestamp() });
                    alert("Thêm thành công!");
                } else {

                    await updateDoc(doc(db, "skibidi", id), payload);
                    alert("Cập nhật thành công!");
                    resetForm();
                }
                form.reset();
            } catch (err) {
                console.error(err);
                alert("Lỗi thao tác!");
            }
        });

        window.deleteStudent = async (id) => {
            if (confirm("Bạn có chắc chắn muốn xóa thí sinh này?")) {
                await deleteDoc(doc(db, "skibidi", id));
            }
        };


        window.editStudent = (id, cccd, sbd, name, van, toan, anh) => {
            document.getElementById("docId").value = id;
            document.getElementById("cccd").value = cccd;
            document.getElementById("sbd").value = sbd;
            document.getElementById("hoten").value = name;
            document.getElementById("van").value = van;
            document.getElementById("toan").value = toan;
            document.getElementById("anh").value = anh;

            formTitle.innerText = "CẬP NHẬT THÔNG TIN";
            btnSave.innerText = "CẬP NHẬT";
            btnCancel.style.display = "block";
            window.scrollTo(0, 0);
        };

        const resetForm = () => {
            document.getElementById("docId").value = "";
            formTitle.innerText = "NHẬP DỮ LIỆU THÍ SINH";
            btnSave.innerText = "LƯU DỮ LIỆU";
            if (btnCancel) btnCancel.style.display = "none";
            form.reset();
        };

        btnCancel.onclick = resetForm;
    </script>

</body>

</html>